# ì˜¤ë˜ëœ ë‰´ìŠ¤ ë°ì´í„° ìë™ ì •ë¦¬ ì‹œìŠ¤í…œ

## ğŸ“‹ ê°œìš”

ì´ ë¬¸ì„œëŠ” GCP News Portalì—ì„œ ì˜¤ë˜ëœ ë‰´ìŠ¤ ë°ì´í„°ë¥¼ ìë™ìœ¼ë¡œ ì •ë¦¬í•˜ëŠ” ì‹œìŠ¤í…œì— ëŒ€í•´ ì„¤ëª…í•©ë‹ˆë‹¤.

## ğŸ¯ ëª©ì 

- **ì €ì¥ ê³µê°„ ìµœì í™”**: ì˜¤ë˜ëœ ë‰´ìŠ¤ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì—¬ Firestore ì‚¬ìš©ëŸ‰ ê°ì†Œ
- **ë¹„ìš© ì ˆê°**: ë¶ˆí•„ìš”í•œ ë°ì´í„° ë³´ê´€ ë¹„ìš© ì ˆê°
- **ì„±ëŠ¥ í–¥ìƒ**: ë°ì´í„° ì¡°íšŒ ì„±ëŠ¥ ê°œì„ 
- **ë°ì´í„° ê´€ë¦¬**: ëª¨ë“  ì‚¬ìš©ìì˜ ë°ì´í„°ë¥¼ ì¼ê´€ë˜ê²Œ ê´€ë¦¬

## ğŸ“Š ë°ì´í„° ë³´ê´€ ì •ì±…

### í˜„ì¬ ì„¤ì •
- **ë³´ê´€ ê¸°ê°„**: 30ì¼
- **ì •ë¦¬ ì£¼ê¸°**: ë§¤ì›” 1íšŒ (ë§¤ì›” 1ì¼ ìƒˆë²½ 3ì‹œ)
- **ëŒ€ìƒ ë°ì´í„°**: ëª¨ë“  ì‚¬ìš©ìì˜ `summaries` ì»¬ë ‰ì…˜

### ë°ì´í„° êµ¬ì¡°
```
Firestore Database:
â””â”€â”€ users (collection)
    â””â”€â”€ {user_id} (document)
        â””â”€â”€ summaries (subcollection)
            â””â”€â”€ {summary_id} (document)
                â”œâ”€â”€ title: string
                â”œâ”€â”€ url: string
                â”œâ”€â”€ summary: string
                â”œâ”€â”€ keyword: string
                â”œâ”€â”€ created_at: string (ISO 8601)
                â””â”€â”€ summaryTokens: number
```

### ì‚­ì œ ê¸°ì¤€
- `created_at` í•„ë“œê°€ í˜„ì¬ ì‹œê°„ìœ¼ë¡œë¶€í„° 30ì¼ ì´ì „ì¸ ëª¨ë“  ë¬¸ì„œ
- ì˜ˆ: 2025-11-01 ì‹¤í–‰ ì‹œ, 2025-10-02 ì´ì „ ë°ì´í„° ì‚­ì œ

## ğŸ—ï¸ ì•„í‚¤í…ì²˜

### ì„ íƒëœ ë°©ì‹: Cloud Function + Cloud Scheduler

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cloud Scheduler     â”‚
â”‚ (ë§¤ì›” 1ì¼ 03:00)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Pub/Sub Topic       â”‚
â”‚ cleanup-old-news    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cloud Function      â”‚
â”‚ cleanup_function    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Firestore           â”‚
â”‚ users/{uid}/        â”‚
â”‚   summaries         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ êµ¬í˜„ ë°©ì‹ ì„ íƒ ì´ìœ 

**Cloud Function ë°©ì‹ì„ ì„ íƒí•œ ì£¼ìš” ì´ìœ :**

1. **ë¹„ìš© íš¨ìœ¨ì„±**
   - ì‹¤í–‰ ì‹œê°„ë§Œ ê³¼ê¸ˆ (ì›” 1íšŒ ì‹¤í–‰)
   - Cloud Run ëŒ€ë¹„ ì•½ 95% ë¹„ìš© ì ˆê° (í•­ìƒ ì‹¤í–‰ ë¶ˆí•„ìš”)

2. **ë…ë¦½ì„±**
   - ë°±ì—”ë“œ APIì™€ ë…ë¦½ì ìœ¼ë¡œ ìš´ì˜
   - ì‹¤íŒ¨ ì‹œ ì‚¬ìš©ì ì„œë¹„ìŠ¤ì— ì˜í–¥ ì—†ìŒ

3. **ê¸°ì¡´ ì¸í”„ë¼ í™œìš©**
   - ì´ë¯¸ Cloud Functions + Scheduler ì‚¬ìš© ì¤‘
   - ë™ì¼í•œ íŒ¨í„´ìœ¼ë¡œ ìœ ì§€ë³´ìˆ˜ ìš©ì´

4. **í™•ì¥ì„±**
   - ì‚¬ìš©ì ìˆ˜ ì¦ê°€ì—ë„ ì•ˆì •ì 
   - Firestore ë°°ì¹˜ ì‘ì—…ì— ìµœì í™”

ìì„¸í•œ ë¹„êµëŠ” [Cloud Function vs Backend API ë¹„êµ ë¬¸ì„œ](./cleanup-implementation-comparison.md)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.

## ğŸ“… ì‹¤í–‰ ìŠ¤ì¼€ì¤„

### Cloud Scheduler ì„¤ì •
- **ìŠ¤ì¼€ì¤„**: `0 3 1 * *` (ë§¤ì›” 1ì¼ ìƒˆë²½ 3ì‹œ)
- **íƒ€ì„ì¡´**: Asia/Seoul (KST)
- **íŠ¸ë¦¬ê±°**: Pub/Sub Topic

### ìŠ¤ì¼€ì¤„ ë³€ê²½ì´ í•„ìš”í•œ ê²½ìš°
```bash
# ë§¤ì£¼ ì‹¤í–‰ìœ¼ë¡œ ë³€ê²½ (ë§¤ì£¼ ì¼ìš”ì¼ ìƒˆë²½ 3ì‹œ)
gcloud scheduler jobs update pubsub cleanup-old-news-job \
  --schedule="0 3 * * 0"

# ë§¤ì¼ ì‹¤í–‰ìœ¼ë¡œ ë³€ê²½
gcloud scheduler jobs update pubsub cleanup-old-news-job \
  --schedule="0 3 * * *"
```

## ğŸ”’ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

1. **ì¸ì¦**: Cloud Functionì€ GCP IAMìœ¼ë¡œ ìë™ ë³´í˜¸
2. **ê¶Œí•œ**: Firestoreì— ëŒ€í•œ ì½ê¸°/ì“°ê¸° ê¶Œí•œ í•„ìš”
3. **ë¡œê¹…**: ëª¨ë“  ì‚­ì œ ì‘ì—…ì€ Cloud Loggingì— ê¸°ë¡

## ğŸ“Š ëª¨ë‹ˆí„°ë§

### Cloud Logging ì¿¼ë¦¬
```
resource.type="cloud_function"
resource.labels.function_name="cleanup-old-news"
severity>=INFO
```

### í™•ì¸ í•­ëª©
- ì²˜ë¦¬ëœ ì‚¬ìš©ì ìˆ˜
- ì‚­ì œëœ ë¬¸ì„œ ìˆ˜
- ì‹¤í–‰ ì‹œê°„
- ì—ëŸ¬ ë°œìƒ ì—¬ë¶€

## âš™ï¸ ì„¤ì • ë³€ê²½ ë°©ë²•

### ë³´ê´€ ê¸°ê°„ ë³€ê²½
Pub/Sub ë©”ì‹œì§€ ìˆ˜ì •:
```bash
gcloud scheduler jobs update pubsub cleanup-old-news-job \
  --message-body='{"retention_days": 60}'
```

### ì‹¤í–‰ ì£¼ê¸° ë³€ê²½
```bash
# 2ì£¼ë§ˆë‹¤ ì‹¤í–‰ (1ì¼, 15ì¼)
gcloud scheduler jobs update pubsub cleanup-old-news-job \
  --schedule="0 3 1,15 * *"
```

## ğŸš€ ë°°í¬ ê°€ì´ë“œ

ìì„¸í•œ ë°°í¬ ë°©ë²•ì€ [êµ¬í˜„ ê°€ì´ë“œ](./cleanup-implementation-guide.md)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.

## ğŸ“ˆ ì˜ˆìƒ íš¨ê³¼

### ë°ì´í„° ê°ì†ŒëŸ‰ (ì˜ˆìƒ)
- ì‚¬ìš©ìë‹¹ í‰ê·  ë‰´ìŠ¤: 100ê°œ/ì›”
- ì‚¬ìš©ì ìˆ˜: 10ëª… ê°€ì •
- ì›”ê°„ ë°ì´í„° ì¦ê°€: ~1,000ê°œ ë¬¸ì„œ
- 30ì¼ ì •ì±… ì‹œ ìœ ì§€: ~1,000ê°œ ë¬¸ì„œ
- 60ì¼ ì •ì±… ì‹œ ìœ ì§€: ~2,000ê°œ ë¬¸ì„œ
- **ì ˆê° íš¨ê³¼**: 50% ë°ì´í„° ê°ì†Œ

### ë¹„ìš© ì ˆê° (ì˜ˆìƒ)
- Firestore ë¬¸ì„œ ì €ì¥: $0.18/GB/ì›”
- í‰ê·  ë¬¸ì„œ í¬ê¸°: 2KB
- 1,000ê°œ ë¬¸ì„œ ì ˆê° = 2MB = **ì•½ $0.0004/ì›”**
- **ì‹¤ì œ íš¨ê³¼**: ì¡°íšŒ ì„±ëŠ¥ í–¥ìƒì´ ë” í° ì´ë“

## ğŸ”„ ìˆ˜ë™ ì‹¤í–‰ ë°©ë²•

ê¸´ê¸‰í•˜ê²Œ ì •ë¦¬ê°€ í•„ìš”í•œ ê²½ìš°:

```bash
# Pub/Sub ë©”ì‹œì§€ ì§ì ‘ ë°œí–‰
gcloud pubsub topics publish cleanup-old-news-topic \
  --message='{"retention_days": 30}'

# ë˜ëŠ” Scheduler Job ì¦‰ì‹œ ì‹¤í–‰
gcloud scheduler jobs run cleanup-old-news-job \
  --location=asia-northeast3
```

## ğŸ“ ë³€ê²½ ì´ë ¥

| ë‚ ì§œ | ë³€ê²½ ë‚´ìš© | ì‘ì„±ì |
|------|----------|--------|
| 2025-11-01 | ì´ˆê¸° ë¬¸ì„œ ì‘ì„± | - |

## ğŸ“š ê´€ë ¨ ë¬¸ì„œ

- [êµ¬í˜„ ê°€ì´ë“œ](./cleanup-implementation-guide.md)
- [Cloud Function vs Backend API ë¹„êµ](./cleanup-implementation-comparison.md)
